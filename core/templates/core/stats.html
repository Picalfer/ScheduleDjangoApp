{% extends "core/base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'core/css/analytics.css' %}">
{% endblock %}

{% block content %}
    <div class="stats-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <h1 class="stats-header">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —à–∫–æ–ª—ã</h1>
        <div class="stats-updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {% now "j F Y H:i" %}</div>

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="stats-grid">
            <!-- –ö–ª–∏–µ–Ω—Ç—ã -->
            <div class="stat-card clients">
                <h2>üë• –ö–ª–∏–µ–Ω—Ç—ã</h2>
                <div class="stat-value">{{ client_stats.total }}</div>
                <div class="stat-details">
                    <span class="negative">üî¥ {{ client_stats.with_negative }} —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º</span>
                    <span>üü° {{ client_stats.low_balance }} —Å –Ω–∏–∑–∫–∏–º –±–∞–ª–∞–Ω—Å–æ–º</span>
                    <span>üü¢ {{ client_stats.new_this_month }} –Ω–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü</span>
                </div>
            </div>

            <div class="stat-card teachers">
                <h2>üë®‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</h2>
                <div class="stat-value">{{ teacher_stats.total }}</div>
                <div class="stat-details">
                    <div class="detail-row">
                        <span class="detail-label">–ù–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü:</span>
                        <span class="detail-value positive">+{{ teacher_stats.new_this_month }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–¢–µ–º–ø —Ä–æ—Å—Ç–∞:</span>
                        <span class="detail-value {{ teacher_stats.growth_trend }}">
                {{ teacher_stats.growth_rate }}%
                            {% if teacher_stats.growth_trend == 'positive' %}‚Üë{% else %}‚Üì{% endif %}
            </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö:</span>
                        <span class="detail-value">{{ teacher_stats.active }} ({{ teacher_stats.active_percent }}%)</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞:</span>
                        <span class="detail-value">{{ teacher_stats.avg_workload }}%</span>
                    </div>
                </div>
            </div>

            <!-- –£—Ä–æ–∫–∏ -->
            <div class="stat-card lessons">
                <h2>üìÖ –£—Ä–æ–∫–∏</h2>
                <div class="stat-value">{{ lesson_stats.today }} —Å–µ–≥–æ–¥–Ω—è</div>
                <div class="stat-details">
                    <span>‚úÖ {{ lesson_stats.completed }} –ø—Ä–æ–≤–µ–¥–µ–Ω–æ</span>
                    <span>‚ùå {{ lesson_stats.canceled }} –æ—Ç–º–µ–Ω–µ–Ω–æ ({{ lesson_stats.cancel_rate }}%)</span>
                    {% for platform in lesson_stats.by_platform %}
                        <span>{{ platform.platform|title }}: {{ platform.count }}</span>
                    {% endfor %}
                </div>
            </div>

            <!-- –§–∏–Ω–∞–Ω—Å—ã -->
            <div class="stat-card finance">
                <h2>üí∞ –§–∏–Ω–∞–Ω—Å—ã</h2>
                <div class="stat-value">{{ finance_stats.monthly_income }} ‚ÇΩ</div>
                <div class="stat-details">
                    <span>–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü</span>
                    <span class="negative">–ù–µ –≤—ã–ø–ª–∞—á–µ–Ω–æ: {{ teacher_stats.unpaid_amount }} ‚ÇΩ</span>
                </div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã -->
        <div class="stats-tables">
            <!-- –¢–æ–ø –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π -->
            <div class="stats-table">
                <h2>üèÜ –¢–æ–ø –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</h2>
                <table>
                    <thead>
                    <tr>
                        <th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
                        <th>–£—Ä–æ–∫–æ–≤</th>
                        <th>–°—Ç—É–¥–µ–Ω—Ç–æ–≤</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for teacher in top_teachers %}
                        <tr>
                            <td>{{ teacher.name }}</td>
                            <td>{{ teacher.lesson_count }}</td>
                            <td>{{ teacher.student_count }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
            <div class="stats-table">
                <h2>üîÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                <table>
                    <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–¢–∏–ø</th>
                        <th>–°—É–º–º–∞</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for op in recent_operations %}
                        <tr>
                            <td>{{ op.date|date:"d.m.Y" }}</td>
                            <td>{{ op.client.name }}</td>
                            <td>{{ op.get_operation_type_display }}</td>
                            <td>{{ op.amount }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>

        <div class="workload-section">
            <h2>üìä –ù–∞–≥—Ä—É–∑–∫–∞ —à–∫–æ–ª—ã: {{ school_workload }}%</h2>
            <div class="recommendation urgent">
                {{ recommendation }}
            </div>

            <div class="teacher-workload-carousel">
                {% for teacher in teachers_workload %}
                    <div class="teacher-card workload-{{ teacher.status }}">
                        <h3>{{ teacher.teacher }}</h3>
                        <div class="workload-bar">
                            <div class="bar-fill" style="width: {{ teacher.workload_percent }}%"></div>
                            <span>{{ teacher.workload_percent }}%</span>
                        </div>
                        <div class="workload-details">
                            <span>–°–≤–æ–±–æ–¥–Ω–æ: {{ teacher.available_slots }} —Å–ª–æ—Ç–æ–≤</span>
                            <span>–ó–∞–Ω—è—Ç–æ: {{ teacher.scheduled_lessons }} —É—Ä–æ–∫–æ–≤</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}