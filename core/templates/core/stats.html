{% extends "core/base.html" %}
{% load humanize %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'core/css/analytics.css' %}">
{% endblock %}

{% block content %}
    <div class="stats-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <h1 class="stats-header">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —à–∫–æ–ª—ã</h1>
        <div class="stats-updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {% now "j F Y H:i" %}</div>

        <!-- –§–∏–Ω–∞–Ω—Å—ã - —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è -->
        <div class="finance-centered">
            <div class="stat-card finance">
                <h2>üí∞ –§–∏–Ω–∞–Ω—Å—ã —à–∫–æ–ª—ã</h2>

                <div class="finance-main">
                    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å -->
                    <div class="finance-balance">
                        <div class="balance-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å —à–∫–æ–ª—ã</div>
                        <div class="balance-value">{{ finance_stats.current_balance|intcomma }} ‚ÇΩ</div>
                        <div class="balance-subtitle">–î–æ—Ö–æ–¥—ã - —Ä–∞—Å—Ö–æ–¥—ã</div>
                    </div>

                    <!-- –°–≤–æ–±–æ–¥–Ω—ã–µ –¥–µ–Ω—å–≥–∏ -->
                    <div class="free-money-section">
                        <div class="free-money-label">üíé –°–≤–æ–±–æ–¥–Ω—ã–µ –¥–µ–Ω—å–≥–∏</div>
                        <div class="free-money-value">{{ finance_stats.free_money|intcomma }} ‚ÇΩ</div>
                        <div class="free-money-subtitle">–ú–æ–∂–Ω–æ –≤–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ</div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π -->
                    <div class="toggle-details-section">
                        <button class="toggle-details-btn" onclick="toggleFinanceDetails()">
                            <span class="toggle-icon">‚ñº</span>
                            –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é
                        </button>
                    </div>

                    <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div id="financeDetails" class="finance-details hidden">
                        <div class="finance-row">
                            <span class="finance-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:</span>
                            <span class="finance-amount">{{ finance_stats.total_income|intcomma }} ‚ÇΩ</span>
                        </div>
                        <div class="finance-row">
                            <span class="finance-label">–í—ã–ø–ª–∞—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º:</span>
                            <span class="finance-amount negative">{{ finance_stats.teacher_expenses|intcomma }} ‚ÇΩ</span>
                        </div>
                        <div class="finance-row">
                            <span class="finance-label">–†–∞—Å—Ö–æ–¥—ã —à–∫–æ–ª—ã:</span>
                            <span class="finance-amount negative">{{ finance_stats.school_expenses|intcomma }} ‚ÇΩ</span>
                        </div>
                        <div class="finance-row highlight">
                            <span class="finance-label">–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤:</span>
                            <span class="finance-amount negative">{{ finance_stats.total_expenses|intcomma }} ‚ÇΩ</span>
                        </div>
                        <div class="finance-row">
                            <span class="finance-label">–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –≤—ã–ø–ª–∞—Ç:</span>
                            <span class="finance-amount warning">{{ finance_stats.reserved_money|intcomma }} ‚ÇΩ</span>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ -->
                        <div class="add-expense-section">
                            <button class="add-expense-btn" onclick="openExpenseModal()">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ —à–∫–æ–ª—ã
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ —à–∫–æ–ª—ã</h3>
                <span class="close" onclick="closeExpenseModal()">&times;</span>
            </div>
            <form id="expenseForm">
                {% csrf_token %}
                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                    <select name="category" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        <option value="advertising">–†–µ–∫–ª–∞–º–∞</option>
                        <option value="software">–°–æ—Ñ—Ç/–ü–æ–¥–ø–∏—Å–∫–∏</option>
                        <option value="taxes">–ù–∞–ª–æ–≥–∏</option>
                        <option value="other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–°—É–º–º–∞ (‚ÇΩ):</label>
                    <input type="number" name="amount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <input type="text" name="description" maxlength="200" required>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ —Ä–∞—Å—Ö–æ–¥–∞:</label>
                    <input type="date" name="expense_date" value="{{ today|date:'Y-m-d' }}" required>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeExpenseModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º–∏ —Ç–µ–≥–∞–º–∏ -->
    <div style="margin-top: 150px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
        <h3>üîç –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>

        <div style="margin-bottom: 20px;">
            <h4>üìä –î–æ—Ö–æ–¥—ã ({{ debug_data.income_details|length }} –æ–ø–µ—Ä–∞—Ü–∏–π):</h4>
            <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                    <tr style="background: #e9ecef;">
                        <th style="padding: 8px; border: 1px solid #ddd;">–î–∞—Ç–∞</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–ö–ª–∏–µ–Ω—Ç</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–°—Ç—É–¥–µ–Ω—Ç</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–£—Ä–æ–∫–æ–≤</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–°—É–º–º–∞ (‚ÇΩ)</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for op in debug_data.income_details %}
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">{{ op.date|date:"d.m.Y" }}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">{{ op.client.name }}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">{{ op.student.name|default:"-" }}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">
                                {% if op.student and op.student.teacher %}
                                    {{ op.student.teacher.user.first_name }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd;">{{ op.amount }}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">{% widthratio op.amount 1 1000 %}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div>
            <h4>üë®‚Äçüè´ –í—ã–ø–ª–∞—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º ({{ debug_data.payment_details|length }} –≤—ã–ø–ª–∞—Ç):</h4>
            <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                    <tr style="background: #e9ecef;">
                        <th style="padding: 8px; border: 1px solid #ddd;">–î–∞—Ç–∞</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–ü–µ—Ä–∏–æ–¥</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–£—Ä–æ–∫–æ–≤</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–°—É–º–º–∞ (‚ÇΩ)</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for payment in debug_data.payment_details %}
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">
                                {% if payment.payment_date %}
                                    {{ payment.payment_date|date:"d.m.Y" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd;">{{ payment.teacher.user.first_name }}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">
                                {{ payment.week_start_date|date:"d.m" }} - {{ payment.week_end_date|date:"d.m.Y" }}
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd;">{{ payment.lessons_count }}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">{{ payment.amount }}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">
                                {% if payment.is_paid %}
                                    ‚úÖ –í—ã–ø–ª–∞—á–µ–Ω–æ
                                {% else %}
                                    ‚è≥ –û–∂–∏–¥–∞–µ—Ç
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="expenseNotification" class="notification hidden"></div>
{% endblock %}

{% block scripts %}
    <script src="{% static 'core/schedule/analytics.js' %}"></script>
{% endblock %}